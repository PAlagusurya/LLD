<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat widget</title>
  </head>
  <body>
    <h3>üí¨ Chat Widget</h3>

    <div id="messages"></div>
    <script>
      const ALLOWED_ORIGINS = ["http://localhost:3000"];

      const now = () => new Date().toLocaleTimeString();

      window.addEventListener("message", (event) => {
        if (event.origin === window.location.origin) {
          return;
        }

        if (!ALLOWED_ORIGINS.includes(event.origin)) {
          console.warn(`[${now()}] ‚ùå Blocked message from:`, event.origin);
          return;
        }

        console.log(`[${now()}] üì© Iframe received:`, event.data);

        if (event.data.type === "SEND_MESSAGE") {
          const messagesDiv = document.getElementById("messages");

          messagesDiv.innerHTML += `
            <p>${event.data.payload.text}</p>`;

          event.source.postMessage(
            {
              type: "MESSAGE_RECEIVED",
              payload: { status: "OK" },
            },
            event.origin
          );
        }
      });

      console.log(`[${now()}] ‚è≥ Iframe loading...`);

      setTimeout(() => {
        console.log(`[${now()}] ‚úÖ Iframe READY`);
        window.parent.postMessage({ type: "IFRAME_READY", time: now() }, "*");
      }, 5000);

      //window.parent is a reference to the window that embedded the iframe
      //window.parent.postMessage(
      //Send a message to the window that contains me.
      //  {
      //    type: "IFRAME_READY",
      // },
      // Send this message to ANY origin
      //("*");
      // );
    </script>
  </body>
</html>
